import{OnFirefox as e,OnEdge as t,OnChrome as l,$ as n,pageTrans_ as o,enableNextTick_ as s,nextTick_ as i,IsEdg_ as u,post_ as r,toggleReduceMotion_ as a,hasShift_ as p,PageOs_ as c,setupPageOs_ as h,prevent_ as d,CurCVer_ as f,escapeAllForRe_ as m}from"./async_bg.js";import{bgSettings_ as _,ExclusionRulesOption_ as g,setupBorderWidth_ as w,showI18n_ as b,setupSettingsCache_ as v}from"./options_base.js";let R,y,k,O,x="",P=0,j=!0,L=null,T=null,E=0,S=/^[a-z][\+\-\.\da-z]+:\/\//,U=n("#state-action"),D=n("#saveOptions"),N=U.nextElementSibling,$=N.nextElementSibling,z=Object.create(null),A=(e,t)=>o(e,t)||"";class H extends g{e(e){super.e(e),this.l.onmousedown=e=>{e.detail>1&&e.target.localName!=="input"&&d(e)}}n(e,t){super.n(H.o(),t)}i(e){return e.r=e.a.pattern&&z[e.a.pattern]||!1,F(e.r)}c(e){super.c(e),H.prototype.c=null,H.prototype.i=g.prototype.i;let t,l=this.h.filter(e=>e.d),n=l.length>0;P=n?2:1,n?(t=l[0].f,V(!0)):(this.n("",!1),t=this.h[this.h.length-1].f),setTimeout(()=>{t.focus()},67)}m(e){let t=super.m(e),l=q(`${R.tabId}/reset/silent`);return Promise.all([t,l]).then(([e])=>e)}g(e,t,l){let n=e.a.pattern===t,o=e.r;super.g(e,t,l);let s=t?l?l.length>1&&l[0]==="^"?A("onlyHook")||"only hook such keys":A("passThrough")||"pass through such keys":A("completelyDisabled")||"completely disabled":"";e.w.title!==t&&(e.w.title=t),e.f.title!==s&&(e.f.title=s),n?e.r=o:this.b(e,t)}b(e,t){let l,n=e.w;e.R&=-5,t&&t!==H.o()?(l=G(e))instanceof Promise?l.then(this.b.bind(this,e,t)):F(l)?n.title=n.style.color="":(e.R|=4,n.style.color="red",n.title="Red text means that the pattern does not\nmatch the current URL."):n.title=n.style.color=""}static o(){let e=R.hasSubDomain,t=(e?x:y).split(/[?#]/)[0],l=e||t.startsWith("http:")?(e<2&&t[4]!==":"?"^https://":"^https?://")+(e?"(?:[^/]+.)?":"")+m(t.split("/",3)[2])+"/":t.startsWith(location.origin+"/")?":vimium:/"+new URL(t).pathname.replace("/pages",""):/^[^:]+:\/\/./.test(t)&&!t.startsWith("file:")?":"+t.split("/",3).join("/")+"/":":"+t;return z[l]||(z[l]=J(l[0]==="^"?{t:1,v:l}:{t:2,v:l.startsWith(":vimium:")?t:l.slice(1)})),H.o=()=>l,l}}let V=e=>{T.y(!0);let t=T.h.filter(e=>e.d&&(!!e.a.pattern||!!(e.R&4))),l=P;P=2,Promise.all(t.map(e=>e.r!==null?e.r:G(e))).then(()=>{C(l,e,t)})},C=(e,t,l)=>{let n=e===3,o=Q(!!x,l);o&&(o=M(o)),t&&(L=e>=2?o:null);let s=o===L,i=!!o&&o.length>2&&o[0]==="^";U.textContent=(n?o?A("137")+A(i?"138":"139"):A("140"):A(s?"141":"142")+A(o?i?"138":"139":s?"143":"143_2")).replace(" to be","")+A("colon")+A("NS"),N.className=o?"code":"",N.textContent=o?i?o.slice(2):o:A("143_3")+A(o!==null?"144":"145"),$.textContent=R.lock!==null&&!n&&s?A("147",[A(R.lock!==0?"144":"145")]):R.lock!==null?A("148"):"";let u=l.some(e=>!!(e.R&4)&&(e.a.pattern!==e.k.pattern||e.a.passKeys!==e.k.passKeys));D.disabled=s&&!u,D.firstChild.data=A(n?"115_3":s&&!u?"115":"115_2")},I=()=>{if(!D.disabled)return s(8),T.O().then(()=>{s(0,8),P=3,W(),V(!0),D.firstChild.data=A("115_3"),D.disabled=!0,j=!0})},M=e=>{let t=(e=e.trim()).length>2&&e.startsWith("^");t&&(e=e.slice(1).trimLeft());let l=Object.create(null);for(let t of e.split(" "))l[t==="*"?A("asterisk"):t]=1;return(t?"^ ":"")+Object.keys(l).sort().join(" ")},q=e=>r(22,[e,R.tabId,R.frameId]).then(e=>{R.status=e[0],R.lock=e[1]}),B=(e,t)=>{t&&d(t);let l=t&&(t.ctrlKey||t.metaKey);q(`${R.tabId}/${e}`).then(()=>{l?(W(),V(!1)):window.close()})},F=e=>!!e&&(e.t===2?y.startsWith(e.v)||!!x&&x.startsWith(e.v):e.t===3?e.v.p.test(y)||!!x&&e.v.p.test(x):e.v.test(y)||!!x&&e.v.test(x)),G=e=>{let t=e.a.pattern,l=z[t];if(l)return e.r=l instanceof Promise?l.then(t=>e.r=t):l;let n=r(23,t);return z[t]=e.r=n.then(l=>z[t]=e.r=J(l))},J=e=>e.t===2?{t:e.t,v:e.v}:e.t===3?{t:e.t,v:{p:f<107?new URLPattern(e.v):new URLPattern(e.v,"http://localhost",{ignoreCase:!0}),s:e.v}}:{t:e.t,v:new RegExp(e.v,"")},K=()=>{let{rules:e,matchers:t}=R.exclusions;for(let l=0,n=e.length;l<n;l++){let n=e[l].pattern;z[n!=="__proto__"?n:"_"]=J(t[l])}},Q=(e,t)=>{let l="";for(let e of t){let t=e.r;if(t&&(t.t===2?y.startsWith(t.v):t.t===3?t.v.p.test(y):t.v.test(y))){let t=e.a.passKeys;if(t.length===0||O||t[0]==="^"&&t.length>2)return t;l+=t}}return!l&&e&&y.lastIndexOf("://",5)<0&&!S.test(y)&&x?Q(!1,t):l||null},W=()=>{k=R.status!==2?"Disable":"Enable";let e=n("#toggleOnce"),t=e.nextElementSibling;i(()=>{e.firstElementChild.textContent=(A(k)||k)+(R.lock!==null?"":A("Once")),e.onclick=B.bind(null,k),N.id="state-value",t.classList.toggle("hidden",R.lock===null),R.lock!==null&&(t.firstElementChild.onclick=B.bind(null,"Reset"))})},X=e=>{let t=n(".options-link"),l=location.origin+"/pages/options.html";e.startsWith(l)?i(()=>{t.nextElementSibling.remove(),t.remove()}):(t.href!==l&&i(()=>{t.href=l}),t.onclick=e=>{d(e),r(15,{u:l,p:!0}).then(()=>{window.close()})})},Y=()=>{c||window.addEventListener("keydown",e=>{e.keyCode===13&&e.metaKey?Z(e):e.altKey&&(e.keyCode===88||R.lock!==null&&e.keyCode===90)&&!(e.ctrlKey||e.metaKey||p(e))&&(d(e),e.stopImmediatePropagation(),B(e.keyCode===88?k:"Reset"))}),T=new H(n("#exclusionRules"),()=>{if(j){j=!1;let e=!E&&n("#helpSpan");e&&(e.nextElementSibling.style.display="",e.remove(),E=1)}V(P<2)}),T.x()};r(20).then(e=>{R=e,h(R.os);let t=R.url,l=n("#blocked-msg");if(s(1),!R.runnable)return te(l),X(t),i(b),void i(ee);i(e=>{l.remove(),l=null,a(R.reduceMotion),e.textContent=R.ver},n("#version")),x=R.topUrl||t,y=R.frameUrl||x,O=R.exclusions.onlyFirst,_.P={exclusionRules:R.exclusions.defaults},v({exclusionRules:R.exclusions.rules}),K(),R.exclusions=null,D.onclick=I,document.addEventListener("keyup",Z),X(t),W(),Y(),i(b),w&&i(w),i(ee)});let Z=e=>{if(e.keyCode===13){let t=e.target;if(t instanceof HTMLAnchorElement)t.hasAttribute("href")||setTimeout(e=>{e.click(),e.blur()},0,t);else if(e.ctrlKey||e.metaKey){let e=!j&&I();e&&e.then(()=>{setTimeout(window.close,300)})}}},ee=()=>{let e=document.documentElement;e.classList.remove("loading"),e.style.width="",e.style.height=""},te=e=>{let t=R.url||"",l=document.body;l.innerText="",e.style.display="",e.querySelector("#version").textContent=R.ver;let o,s,i=e.querySelector("#refresh-after-install");R.tabId<0||!t||!/^(ht|s?f)tp/i.test(t)?i.remove():!u&&(o=navigator.userAgentData,(s=o.brands)?s.find(e=>e.brand.includes("Opera")):/\b(Opera|OPR)\//.test(navigator.userAgent))&&/\.(google|bing|baidu)\./.test(t.split("/",4).slice(0,3).join("/"))&&(e.querySelector("#opera-warning").style.display=""),l.append(e);let a=R.unknownExt;if(a){let e=n("#injection-refused");e.style.display="",e.nextElementSibling.remove(),n("#doAllowExt").onclick=function(){this.onclick=null,r(21,[R.tabId,a]).then(()=>{setTimeout(()=>{location.reload()},0)})}}let p=n("#retryInject");p&&(/^(file|ftps?|https?):/.test(t)&&R.tabId>=0?p.onclick=e=>{d(e),r(6,R.tabId).then(()=>{window.close()})}:(p.nextElementSibling.remove(),p.remove()))};